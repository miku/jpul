var BLANKLINE="";var Wysiwym={};$.fn.wysiwym=function(b,a){this.EDITORCLASS="wysiwym-editor";this.BUTTONCLASS="wysiwym-buttons";this.HELPCLASS="wysiwym-help";this.HELPTOGGLECLASS="wysiwym-help-toggle";this.textelem=this;this.textarea=$(this);this.editor=undefined;this.markup=new b(this);this.defaults={containerButtons:undefined,containerHelp:undefined,helpEnabled:true,helpToggle:true,helpToggleElem:undefined,helpTextShow:"show markup syntax",helpTextHide:"hide markup syntax"};this.options=$.extend(this.defaults,a?a:{});this.initializeButtons=function(){var c=this.markup;if(this.options.containerButtons==undefined){this.options.containerButtons=$("<div></div>").insertBefore(this.textarea)}this.options.containerButtons.addClass(this.BUTTONCLASS);for(var e=0;e<c.buttons.length;e++){var d=c.buttons[e];var g=d.create();if(e==0){g.addClass("first")}if(e==c.buttons.length-1){g.addClass("last")}var f=$.extend({markup:this.markup},d.data);g.bind("click",f,d.callback);this.options.containerButtons.append(g)}};this.initializeAutoIndent=function(){if(this.markup.autoindents){var c={markup:this.markup};this.textarea.bind("keydown",c,Wysiwym.autoIndent)}};this.initializeHelp=function(){this.options.containerHelp=a.containerHelp;if(this.options.containerHelp==undefined){this.options.containerHelp=$("<div></div>").insertAfter(this.textarea)}this.options.containerHelp.addClass(this.HELPCLASS);var e=$("<tbody></tbody>");var f=$('<table cellpadding="0" cellspacing="0" border="0"></table>').append(e);for(var c=0;c<this.markup.help.length;c++){var d=this.markup.help[c];e.append("<tr><th>"+d.label+"</th><td>"+d.syntax+"</td></tr>")}this.options.containerHelp.append(f)};this.initializeHelpToggle=function(){var c=this.options;if(c.helpToggle){this.options.helpToggleElem=c.helpToggleElem;if(this.options.helpToggleElem==undefined){this.options.helpToggleElem=$("<a href='#'>"+c.helpTextShow+"</a>")}this.options.helpToggleElem.addClass(this.HELPTOGGLECLASS);this.options.helpToggleElem.bind("click",function(){if(c.containerHelp.is(":visible")){c.containerHelp.slideUp("fast");$(this).text(c.helpTextShow)}else{c.containerHelp.slideDown("fast");$(this).text(c.helpTextHide)}return false});c.containerHelp.before(this.options.helpToggleElem).hide()}};this.editor=$('<div class="'+this.EDITORCLASS+'"></div>');this.textarea.wrap(this.editor);this.initializeButtons();this.initializeAutoIndent()};Wysiwym.Selection=function(a){this.lines=a.lines;this.start={line:0,position:0},this.end={line:0,position:0},this.toString=function(){var b="SELECTION: "+this.length()+" chars\n";b+="START LINE: "+this.start.line+"; POSITION: "+this.start.position+"\n";b+="END LINE: "+this.end.line+"; POSITION: "+this.end.position+"\n";return b};this.addLinePrefixes=function(c){for(var b=this.start.line;b<=this.end.line;b++){this.lines[b]=c+this.lines[b]}this.start.position+=c.length;this.end.position+=c.length};this.addPrefix=function(e){var g=this.lines.length;var b=this.lines[this.start.line];var c=b.substring(0,this.start.position)+e+b.substring(this.start.position,b.length);this.lines[this.start.line]=c;this.start.position+=e.length;if(this.start.line==this.end.line){this.end.position+=e.length}if(e.indexOf("\n")!=-1){var d=a.textelem.scrollHeight;var f=parseInt(d/g);a.scroll+=f}};this.addSuffix=function(d){var b=this.lines[this.end.line];var c=b.substring(0,this.end.position)+d+b.substring(this.end.position,b.length);this.lines[this.end.line]=c};this.append=function(d){var b=this.lines[this.end.line];var c=b.substring(0,this.end.position)+d+b.substring(this.end.position,b.length);this.lines[this.end.line]=c;this.end.position+=d.length};this.getLines=function(){var b=[];for(var c=this.start.line;c<=this.end.line;c++){b[b.length]=this.lines[c]}return b};this.hasPrefix=function(c){var b=this.lines[this.start.line];var d=this.start.position-c.length;if((d<0)||(b.substring(d,this.start.position)!=c)){return false}return true};this.hasSuffix=function(d){var c=this.lines[this.end.line];var b=this.end.position+d.length;if((b>c.length)||(c.substring(this.end.position,b)!=d)){return false}return true};this.insertPreviousLine=function(b,c){c=c!==undefined?c:true;var d=this.start.line-1;if((c)||((d>=0)&&(this.lines[d]!=b))){this.lines.splice(this.start.line,0,b);this.start.line+=1;this.end.line+=1}};this.insertNextLine=function(b,d){d=d!==undefined?d:true;var c=this.end.line+1;if((d)||((c<this.lines.length)&&(this.lines[c]!=b))){this.lines.splice(c,0,b)}};this.isWrapped=function(b,c){return((this.hasPrefix(b))&&(this.hasSuffix(c)))};this.length=function(){return this.val().length};this.linesHavePrefix=function(d){for(var c=this.start.line;c<=this.end.line;c++){var b=this.lines[c];if((typeof(d)=="string")&&(!b.startswith(d))){return false}else{if((typeof(d)!="string")&&(!b.match(d))){return false}}}return true};this.prepend=function(d){var b=this.lines[this.start.line];var c=b.substring(0,this.start.position)+d+b.substring(this.start.position,b.length);this.lines[this.start.line]=c;if(this.start.line==this.end.line){this.end.position+=d.length}};this.removeLinePrefixes=function(e){for(var d=this.start.line;d<=this.end.line;d++){var b=this.lines[d];var c=e;if(typeof(e)!="string"){c=b.match(e)[0]}if(b.startswith(c)){this.lines[d]=b.substring(c.length,b.length);if(d==this.start.line){this.start.position-=c.length}if(d==this.end.line){this.end.position-=c.length}}}};this.removeNextLine=function(d){var b=this.end.line+1;var c=false;if((b<this.lines.length)&&(d)&&(this.lines[b].match(d))){c=true}if((b<this.lines.length)&&(!d)){c=true}if(c){this.lines.splice(b,1)}};this.removePrefix=function(d){if(this.hasPrefix(d)){var b=this.lines[this.start.line];var e=this.start.position-d.length;var c=b.substring(0,e)+b.substring(this.start.position,b.length);this.lines[this.start.line]=c;this.start.position-=d.length;if(this.start.line==this.end.line){this.end.position-=d.length}}};this.removePreviousLine=function(c){var d=this.start.line-1;var b=false;if((d>=0)&&(c)&&(this.lines[d].match(c))){b=true}if((d>=0)&&(!c)){b=true}if(b){this.lines.splice(d,1);this.start.line-=1;this.end.line-=1}};this.removeSuffix=function(e){if(this.hasSuffix(e)){var c=this.lines[this.end.line];var b=this.end.position+e.length;var d=c.substring(0,this.end.position)+c.substring(b,c.length);this.lines[this.end.line]=d}};this.setLinePrefixes=function(f,b){b=b?b:false;for(var e=this.start.line;e<=this.end.line;e++){if(!this.lines[e].startswith(f)){if(b){var d=parseInt(f.match(/\d+/)[0]);f=f.replace(d,d+1)}var c=this.lines[e].match(/^\s*/)[0].length;this.lines[e]=this.lines[e].lstrip();this.lines[e]=f+this.lines[e];if(e==this.start.line){this.start.position+=f.length-c}if(e==this.end.line){this.end.position+=f.length-c}}}};this.unwrap=function(b,c){this.removePrefix(b);this.removeSuffix(c)};this.unwrapBlankLines=function(){a.selection.removePreviousLine(/^\s*$/);a.selection.removeNextLine(/^\s*$/)};this.val=function(){var d="";for(var c=0;c<this.lines.length;c++){var b=this.lines[c];if((c==this.start.line)&&(c==this.end.line)){return b.substring(this.start.position,this.end.position)}else{if(c==this.start.line){d+=b.substring(this.start.position,b.length)+"\n"}else{if((c>this.start.line)&&(c<this.end.line)){d+=b+"\n"}else{if(c==this.end.line){d+=b.substring(0,this.end.position)}}}}}return d};this.wrap=function(b,c){this.addPrefix(b);this.addSuffix(c)};this.wrapBlankLines=function(){if(a.selection.start.line>0){a.selection.insertPreviousLine(BLANKLINE,false)}if(a.selection.end.line<a.lines.length-1){a.selection.insertNextLine(BLANKLINE,false)}}};Wysiwym.Textarea=function(a){this.textelem=a.get(0);this.textarea=a;this.lines=[];this.selection=new Wysiwym.Selection(this);this.scroll=this.textelem.scrollTop;this.toString=function(){var c="TEXTAREA: #"+this.textarea.attr("id")+"\n";c+=this.selection.toString();c+="SCROLL: "+this.scroll+"px\n";c+="---\n";for(var b=0;b<this.lines.length;b++){c+="LINE "+b+": "+this.lines[b]+"\n"}return c};this.getProperties=function(){var e="";var c=0;var d=0;for(var b=0;b<this.lines.length;b++){if(b==this.selection.start.line){c=e.length+this.selection.start.position}if(b==this.selection.end.line){d=e.length+this.selection.end.position}e+=this.lines[b];if(b!=this.lines.length-1){e+="\n"}}return[e,c,d]};this.getSelectionStartEnd=function(){if(typeof(this.textelem.selectionStart)=="number"){var g=this.textelem.selectionStart;var f=this.textelem.selectionEnd}else{this.textelem.focus();var h=this.textelem.value.replace(/\r\n/g,"\n");var e=h.length;var d=document.selection.createRange();var c=this.textelem.createTextRange();c.moveToBookmark(d.getBookmark());var b=this.textelem.createTextRange();b.collapse(false);if(c.compareEndPoints("StartToEnd",b)>-1){var g=e;var f=e}else{var g=-c.moveStart("character",-e);if(c.compareEndPoints("EndToEnd",b)>-1){var f=e}else{var f=-c.moveEnd("character",-e)}}}return[g,f]};this.update=function(){var c=this.getProperties();var f=c[0];var d=c[1];var e=c[2];this.textarea.val(f);if(this.textelem.setSelectionRange){this.textelem.setSelectionRange(d,e)}else{if(this.textelem.createTextRange){var b=this.textelem.createTextRange();b.collapse(true);b.moveStart("character",d);b.moveEnd("character",e-d);b.select()}}console.log("Set scroll: "+this.scroll);this.textelem.scrollTop=this.scroll;this.textarea.focus()};this.init=function(){var g=a.val().replace(/\r\n/g,"\n");var e=this.getSelectionStartEnd(this.textelem);var c=e[0];var d=e[1];var f=0;while(f>=0){var f=g.indexOf("\n");var b=g.substring(0,f>=0?f:g.length);if((c<=b.length)&&(d>=0)){if(c>=0){this.selection.start.line=this.lines.length;this.selection.start.position=c}if(d<=b.length){this.selection.end.line=this.lines.length;this.selection.end.position=d}}this.lines[this.lines.length]=b;g=f>=0?g.substring(f+1,g.length):"";c-=f+1;d-=f+1}if((this.selection.end.position==0)&&(this.selection.end.line!=this.selection.start.line)){this.selection.end.line-=1;this.selection.end.position=this.lines[this.selection.end.line].length}};this.init()};Wysiwym.Button=function(a,d,c,b){this.name=a;this.callback=d;this.data=c?c:{};this.cssclass=b;this.getCssClass=function(){if(!this.cssclass){return this.name.toLowerCase().replace(" ","")}return this.cssclass};this.create=function(){var g=$('<span class="text">'+this.name+"</span>");var f=$('<span class="wrap"></span>').append(g);var e=$('<div class="button"></div>').append(f);e.attr("title",this.name);e.addClass(this.getCssClass());g.attr("unselectable","on");f.attr("unselectable","on");e.attr("unselectable","on");return e}};Wysiwym.span=function(c){var a=c.data.markup;var d=c.data.prefix;var e=c.data.suffix;var f=c.data.text;var b=new Wysiwym.Textarea(a.textarea);if(b.selection.isWrapped(d,e)){b.selection.unwrap(d,e)}else{if(b.selection.length()==0){b.selection.append(f);b.selection.wrap(d,e)}else{b.selection.wrap(d,e)}}b.update()};Wysiwym.list=function(e){var a=e.data.markup;var f=e.data.prefix;var b=e.data.wrap;var d=e.data.regex;var c=new Wysiwym.Textarea(a.textarea);if(c.selection.linesHavePrefix(d?d:f)){c.selection.removeLinePrefixes(d?d:f);if(b){c.selection.unwrapBlankLines()}}else{c.selection.setLinePrefixes(f,d);if(b){c.selection.wrapBlankLines()}}c.update()};Wysiwym.block=function(e){var a=e.data.markup;var f=e.data.prefix;var b=e.data.wrap;var d=new Wysiwym.Textarea(a.textarea);var c=d.selection.getLines()[0];if(c.startswith(f)){d.selection.removeLinePrefixes(f);if(b){d.selection.unwrapBlankLines()}}else{d.selection.addLinePrefixes(f);if(b){d.selection.wrapBlankLines()}}d.update()};Wysiwym.autoIndent=function(a){if(a.keyCode!=13){return true}var l=a.data.markup;var c=new Wysiwym.Textarea(l.textarea);var g=c.selection.start.line;var m=c.lines[g];var b=m.substring(c.selection.start.position,m.length);if((c.selection.length()!=0)||(b)){return true}for(var d=0;d<l.autoindents.length;d++){var j=l.autoindents[d];var f=m.match(j);if(f){var h=f[0];var k=m.substring(h.length,m.length);if(f.length==2){var e=parseInt(f[1]);h=h.replace(f[1],e+1)}if(k){c.selection.addPrefix("\n"+h);c.update();return false}else{c.lines[g]=BLANKLINE;c.selection.start.position=0;c.selection.end.position=c.selection.start.position;if(l.exitindentblankline){c.selection.addPrefix("\n")}c.update();return false}}}return true};Wysiwym.Markdown=function(a){this.textarea=a;this.buttons=[new Wysiwym.Button("Bold",Wysiwym.span,{prefix:"**",suffix:"**",text:"strong text"}),new Wysiwym.Button("Italic",Wysiwym.span,{prefix:"_",suffix:"_",text:"italic text"}),new Wysiwym.Button("Link",Wysiwym.span,{prefix:"[",suffix:"](http://example.com)",text:"link text"}),new Wysiwym.Button("Bullet List",Wysiwym.list,{prefix:"* ",wrap:true}),new Wysiwym.Button("Number List",Wysiwym.list,{prefix:"0. ",wrap:true,regex:/^\s*\d+\.\s/}),new Wysiwym.Button("Quote",Wysiwym.list,{prefix:"> ",wrap:true}),new Wysiwym.Button("Code",Wysiwym.block,{prefix:"    ",wrap:true})];this.exitindentblankline=true;this.autoindents=[/^\s*\*\s/,/^\s*(\d+)\.\s/,/^\s*\>\s/,/^\s{4}\s*/];this.help=[{label:"Header",syntax:"## Header ##"},{label:"Bold",syntax:"**bold**"},{label:"Italic",syntax:"_italics_"},{label:"Link",syntax:"[pk!](http://google.com)"},{label:"Bullet List",syntax:"* list item"},{label:"Number List",syntax:"1. list item"},{label:"Blockquote",syntax:"&gt; quoted text"},{label:"Large Code Block",syntax:"(Begin lines with 4 spaces)"},{label:"Inline Code Block",syntax:"&lt;code&gt;inline code&lt;/code&gt;"}]};Wysiwym.Mediawiki=function(a){this.textarea=a;this.buttons=[new Wysiwym.Button("Bold",Wysiwym.span,{prefix:"'''",suffix:"'''",text:"strong text"}),new Wysiwym.Button("Italic",Wysiwym.span,{prefix:"''",suffix:"''",text:"italic text"}),new Wysiwym.Button("Link",Wysiwym.span,{prefix:"[http://example.com ",suffix:"]",text:"link text"}),new Wysiwym.Button("Bullet List",Wysiwym.list,{prefix:"* ",wrap:true}),new Wysiwym.Button("Number List",Wysiwym.list,{prefix:"# ",wrap:true}),new Wysiwym.Button("Quote",Wysiwym.span,{prefix:"<blockquote>",suffix:"</blockquote>",text:"quote text"}),new Wysiwym.Button("Code",Wysiwym.span,{prefix:"<pre>",suffix:"</pre>",text:"code text"})];this.exitindentblankline=true;this.autoindents=[/^\s*\*\s/,/^\s*\#\s/];this.help=[{label:"Header",syntax:"== Header =="},{label:"Bold",syntax:"'''bold'''"},{label:"Italic",syntax:"''italics''"},{label:"Link",syntax:"[http://google.com pk!]"},{label:"Bullet List",syntax:"* list item"},{label:"Number List",syntax:"# list item"},{label:"Blockquote",syntax:"&lt;blockquote&gt;quote&lt;/blockquote&gt;"},{label:"Large Code Block",syntax:"&lt;pre&gt;Code block&lt;/pre&gt;"}]};Wysiwym.BBCode=function(a){this.textarea=a;this.buttons=[new Wysiwym.Button("Bold",Wysiwym.span,{prefix:"[b]",suffix:"[/b]",text:"strong text"}),new Wysiwym.Button("Italic",Wysiwym.span,{prefix:"[i]",suffix:"[/i]",text:"italic text"}),new Wysiwym.Button("Link",Wysiwym.span,{prefix:'[url="http://example.com"]',suffix:"[/url]",text:"link text"}),new Wysiwym.Button("Quote",Wysiwym.span,{prefix:"[quote]",suffix:"[/quote]",text:"quote text"}),new Wysiwym.Button("Code",Wysiwym.span,{prefix:"[code]",suffix:"[/code]",text:"code text"})];this.help=[{label:"Bold",syntax:"[b]bold[/b]"},{label:"Italic",syntax:"[i]italics[/i]"},{label:"Link",syntax:'[url="http://example.com"]pk![/url]'},{label:"Blockquote",syntax:"[quote]quote text[/quote]"},{label:"Large Code Block",syntax:"[code]code text[/code]"}]};String.prototype.strip=function(){return this.replace(/^\s+|\s+$/g,"")};String.prototype.lstrip=function(){return this.replace(/^\s+/,"")};String.prototype.rstrip=function(){return this.replace(/\s+$/,"")};String.prototype.startswith=function(a){return this.substring(0,a.length)==a};String.prototype.endswith=function(a){return this.substring(a.length,this.length)==a};